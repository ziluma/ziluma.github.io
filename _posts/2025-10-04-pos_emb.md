---
layout: post
title: "Position Embeddings: Sinusoidal, RoPE"
date: 2025-10-04
math: true
published: true
---

Position embeddings are important in NLP (transformer), CV (diffusion), and others.
The Sinusoidal embedding introduced in [transformer](https://arxiv.org/abs/1706.03762) is quite mysterious and I hope to understand it better.

In transformer, say there are $V$ words in total, and $w_i\in \mathbb{R}^D$ is the embedding for word $i$. 
An input of shape $B\times T$ (batch and length) becomes $B\times T\times D$ after embedding and is then fed into attention. 
Now there's nothing special about words' positions, but this info is too important to ignore.

Suppose $D=2d$,
we have an **absolute** position embedding $\phi_t(x)\in \mathbb{C}^d$ for position $t$, and $\phi_t$ is shared by both queries and keys.
We hope the inner products of embeddings should contain **relative** positional infomation.

Given a single query and key $\mathbf{q},\mathbf{k}\in \mathbb{R}^D$, their embeddings should satisfy

$$
    \langle \phi_t(\mathbf{q}), \overline{\phi_s(\mathbf{k})}\rangle = \psi(\mathbf{q},\mathbf{k},t-s)
$$

for some $\psi$.

Naturally, we assume $\phi(z,0)=z.$ 
Then 

$$
\langle \phi_t(z), \overline{\phi_t(w)}\rangle
=\psi(z,w,0)=\langle \phi(z,0), \overline{\phi(w,0)}\rangle=\langle z,\bar w\rangle.
$$

Fancy word: $\phi_t$ is isometry on $\mathbb{C}^n$, and thus $\phi_t(z)=U_tz$ for some unitary matrix $U_t$ satisfying $U_t^* U_t=I$. 

[RoPE](https://arxiv.org/pdf/2104.09864) considers **diagonal** $U_t.$
For $|z|=1,$

$$
z^*U_{t-1}^*U_tz=\langle U_t z,\overline{U_{t-1}z}\rangle = \psi(z,z,1)
$$

which is independent of $t$. 
Replacing $z$ by $e_1,\cdots,e_d$, $U_{t-1}^*U_t=\Theta$ for some diagonal unitary $\Theta$ independent of $t$.

$$
U_t = U_0^*U_t = (U_0^*U_1)(U_1^*U_2)\cdots(U_{t-1}^*U_t) = \Theta^t.
$$

We are free to choose $\Theta$. Similar to Sinusoidal, RoPE considers angles of the form $\theta^{k/d}$:

$$
    \Theta = {\rm diag}(\mathrm{e}^{\mathrm{i}\theta^{0/d}},
    \mathrm{e}^{\mathrm{i}\theta^{1/d}},\cdots,\mathrm{e}^{\mathrm{i}\theta^{(d-1)/d}}),\quad 
    \phi_t(z)=\Theta^tz
$$

where $\theta=10^{-8}.$